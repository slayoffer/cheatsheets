## Подготовка

Снимок диска содержит только те данные, которые были записаны на диск в момент создания снимка. Если диск подключен к работающей виртуальной машине, то кеш приложений и операционной системы не попадет в снимок.

Чтобы обеспечить целостность данных снимка:

**Для Linux-систем:**

1. Остановите все операции записи на диск в приложениях.

2. Запишите кэш операционной системы на диск:

   ```bash
   sync
   ```

3. Заморозьте файловую систему:

   ```bash
   sudo fsfreeze --freeze <точка_монтирования>
   # example
   sudo fsfreeze -f /mnt/dir
   ```

   Где `--freeze` — параметр для заморозки файловой системы. Вместо `<точка_монтирования>` укажите каталог, к которому подключена файловая система. Например: `/mnt/vdc2`.

4. Создайте снимок по инструкции [ниже](https://cloud.yandex.ru/docs/compute/operations/disk-control/create-snapshot#create).

5. Разморозьте файловую систему:

   ```bash
   sudo fsfreeze --unfreeze <точка_монтирования>
   # example
   sudo fsfreeze --unfreeze /mnt/dir
   ```

   Где `--unfreeze` — параметр для разморозки файловой системы. Вместо `<точка_монтирования>` укажите каталог, к которому подключена файловая система. Например: `/mnt/vdc2`.

   

**Для остальных систем:**

1. Остановите виртуальную машину (см. раздел [Остановить](https://cloud.yandex.ru/docs/compute/operations/vm-control/vm-stop-and-start#stop)).
2. Дождитесь, когда статус машины изменится на `STOPPED`.



### Намеренное повреждение системы

1. Теперь протестируйте обновление системы: в командной строке с интерфейсом подключения к ВМ по SSH последовательно выполните команды `apt-get update` и `apt-get dist-upgrade`. Дождитесь, пока обновление завершится.

    **Важно!** Перед выполнением следующей команды убедитесь в том, что находитесь в консоли именно тестовой ВМ.

2. Сымитируйте повреждение системы: выполните команду `sudo rm -rf --no-preserve-root /`. Вы увидите предупреждение, что все данные на диске будут удалены. Подтвердите своё намерение.

### Восстановление из снимка

1. Поскольку снимок создан с загрузочного диска, который всегда подключён к ВМ, для восстановления создайте новую ВМ вместо старой. При создании загрузочного диска машины выберите готовый снимок диска. Для этого в блоке **Выбор образа/загрузочного диска** перейдите на вкладку **Пользовательские** и нажмите кнопку **Выбрать**. В открывшемся окне перейдите на вкладку **Снимок**, выберите нужный снимок и нажмите кнопку **Применить**.