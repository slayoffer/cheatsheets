# Создание группы виртуальных машин

Иногда вам требуется не автоматическое масштабирование, а автоматическое восстановление ВМ. Например, если вы отлаживаете работу веб-сервиса, который периодически падает. Для этого подойдут группы ВМ фиксированного размера. Давайте создадим и настроим такую группу.

1. В консоли управления откройте раздел **Compute Cloud**, перейдите на вкладку **Группы виртуальных машин** и нажмите кнопку **Создать группу**.

    Откроется страница **Создание группы виртуальных машин**.

1. В блоке 

   Базовые параметры

    введите имя и описание группы ВМ. Создайте новый сервисный аккаунт. Чтобы иметь возможность создавать, обновлять и удалять ВМ в группе, назначьте сервисному аккаунту роль 

   ```
   editor
   ```

   . По умолчанию все операции в группе ВМ выполняются от имени сервисного аккаунта.

   ВМ группы могут находиться в разных зонах и регионах. В блоке **Распределение** выберите две зоны доступности, чтобы обеспечить доступность сервиса, если в одной из них случится сбой.

1. В блоке **Шаблон виртуальной машины** нажмите кнопку **Задать**.

   Шаблон создается так же, как и сама ВМ. В блоке **Базовые параметры** введите описание шаблона конфигурации, затем в блоке **Выбор образа/загрузочного диска** на вкладке **Операционные системы** выберите **Ubuntu**.

   В блоках **Диски** и **Вычислительные ресурсы** для загрузочного диска оставьте значения по умолчанию. В блоке **Сетевые настройки** выберите существующую сеть и подсеть или создайте новые. В блоке **Доступ** выберите существующий или создайте новый сервисный аккаунт, укажите логин, вставьте в поле **SSH-ключ** содержимое файла с публичным ключом, доступ к серийной консоли не разрешайте.

1. Сохраните параметры и вы вернётесь на страницу **Создание группы виртуальных машин**.

2. В блоке **В процессе создания и обновления разрешено** установите политику развертывания: 

   - **Добавлять выше целевого значения** (на сколько ВМ можно превышать размер группы) — `2`.

   - **Уменьшать относительно целевого значения** (на сколько ВМ можно уменьшать размер группы) — `1`.

   - **Одновременно создавать** (сколько ВМ можно сразу создавать в группе) — `2`.

   - **Время запуска** (сколько времени должно пройти, прежде чем будут пройдены все проверки состояния и ВМ начнет получать нагрузку) — `2 минуты`.

   - **Одновременно останавливать** (сколько ВМ можно сразу удалять) — `1`.

   - Останавливать машины по стратегии

      — 

     ```
     Принудительная
     ```

     .

      При принудительной стратегии Instance Groups самостоятельно выбирает, какие ВМ остановить.

     В блоке **Масштабирование** выберите `фиксированный` тип, **Размер** (количество ВМ) — `3`.

3. В блоке **Интеграция с Load Balancer** оставьте опцию **Создать целевую группу** выключенной. Не включайте пока проверку состояний, которая позволяет Instance Groups получать сведения о состоянии ВМ.

4. Нажмите кнопку **Создать** и вернитесь на страницу **Группы виртуальных машин**. В правом нижнем углу появится сообщение «Группа виртуальных машин создаётся». Одновременно можно создавать не более двух ВМ. Поэтому сначала будут созданы две ВМ, потом — третья.

5. После того как вы создали группу, протестируйте включение и выключение всех машин сразу. Обратите внимание: в соответствии с настройками сервис инициирует запуск не более двух машин одновременно. Третья ВМ будет оставаться остановленной. Как только первая будет запущена, один слот на запуск освободится, поэтому сразу будет инициирован запуск третьей и последней ВМ.



# Автоматическое масштабирование под нагрузкой

Давайте разберёмся, как обеспечить доступность сервиса под высокой нагрузкой. Вы уже научились создавать группы ВМ. Теперь создадим автоматически масштабируемую группу ВМ. 

1. В консоли управления откройте раздел **Compute Cloud**. Перейдите на вкладку **Группы виртуальных машин** и нажмите кнопку **Создать группу.** Задайте имя группе ВМ.

   Создайте [сервисный аккаунт](https://cloud.yandex.ru/docs/iam/concepts/users/service-accounts). Чтобы иметь возможность создавать, обновлять и удалять ВМ в группе, назначьте сервисному аккаунту роль `editor`. По умолчанию все операции в группе ВМ выполняются от имени сервисного аккаунта.

2. В блоке **Распределение** выберите только одну зону доступности.

3. В блоке **Шаблон виртуальной машины** нажмите кнопку **Задать.** В открывшемся окне выберите: 

   - ОС: Ubuntu 20.04.

   - Размер загрузочного диска: 50 ГБ.

   - Тип загрузочного диска: SSD.

   - Остальные параметры — по умолчанию. Не забудьте добавить публичный SSH-ключ. Он понадобится нам на следующем практическом занятии.

     В блоке **В процессе создания и обновления разрешено** оставьте параметры по умолчанию.

4. Перейдите к блоку **Масштабирование** и выберите тип **Автоматический**.

   Задайте параметры масштабирования: 

   - **Тип автомасштабирования** — `зональное`. При зональном автомасштабировании количество ВМ регулируется отдельно в каждой зоне доступности, указанной в настройках группы.
   - **Минимальное количество ВМ в зоне** — `2`. Сервис Instance Groups не будет удалять ВМ в зоне доступности, если их там всего две.
   - **Максимальный размер группы** — `4`. Instance Groups не будет создавать ВМ, если их уже четыре. В этот раз размер загрузочного диска ВМ — 50 ГБ, поэтому с учётом квот на суммарный объём SSD-дисков в одном облаке смогут запуститься четыре ВМ.
   - **Промежуток измерения загрузки** (это период усреднения: время, за которое следует усреднять замеры нагрузки для каждой ВМ в группе) — `60 секунд`.
   - **Время на разогрев ВМ** — `3 минуты`. В течение этого времени ВМ не учитывается в измерении средней нагрузки на группу. Фактически данное время мы можем определить, измерив, как быстро запускается ВМ.
   - **Период стабилизации** — `5 минут`. Отсчитывается с момента, когда Compute Cloud принял последнее решение о том, что количество ВМ в группе нужно увеличить.
   - **Начальный размер группы** — `4`. Это количество ВМ, которое следует создать вместе с группой.

5. В блоке **Метрики** укажите: 

   - **Тип** — `CPU`.

   - Целевой уровень загрузки CPU, %

      — 

     ```
     80
     ```

     . Instance Groups будет управлять размером группы так, чтобы поддерживать указанную нагрузку CPU.

     Нажмите кнопку **Создать**. Сервис начнет создавать ВМ. После создания статус группы изменится на **Active**. Обратите внимание, как меняются **Состояния ВМ**.

    **Creating instance** — ВМ создаётся и запускается.

   **Awaiting warmup duration** — ВМ начинает принимать сетевой трафик. В этом статусе ВМ находится в течение периода прогрева, указанного в настройках автоматического масштабирования. Значения метрик ВМ в этом статусе заменяются средними значениями ВМ из той же зоны доступности.

   **Running actual** — ВМ запущена, на неё подается сетевой трафик, пользовательские приложения работают.

   ​    Группа ВМ готова принимать рабочую нагрузку.

# Воссоздание виртуальных машин в группе

Давайте сымитируем рост нагрузки на ВМ и посмотрим, как сервис на это отреагирует. 

1. В консоли управления откройте раздел **Compute Cloud** и перейдите на страницу группы ВМ, которую вы создали на прошлом практическом занятии. Откройте в двух вкладках браузера страницы **Группы виртуальных машин** и **Мониторинг** (открывается из раздела **Группы виртуальных машин**).
2. После запуска группы зайдите по SSH на каждую из двух ВМ и установите приложение для стресс-тестирования Linux-систем. Для этого выполните команду:

 

Скопировать код

```
sudo apt-get install stress 
```

1. После этого для каждой ВМ запустите установленное приложение:

Скопировать кодBASH

```
stress -c 2 
```

​    Аргумент `-c` означает, что при тестировании будет нагружаться процессор, а число после аргумента задаёт количество ядер процессора, которые будут нагружаться. Чтобы эксперимент удался — укажите количество ядер, которое вы выбрали в шаблоне ВМ.

1. На вкладке со страницей мониторинга на графике **Average CPU utilization in ru-central1-a** следите за тем, как усреднённое значение нагрузки будет постепенно расти.

   Как только усреднённое значение нагрузки превысит порог, сервис Instance Groups начнёт прогревать две дополнительные ВМ и вводить их в строй. Это будет видно на странице **Группы виртуальных машин**.

   Поскольку стресс-тест не остановлен, сервис завершает запуск двух ВМ.

   Через некоторое время усреднённое значение нагрузки процессоров в группе упадёт до 50%, поскольку первая половина ВМ загружена полностью, а вторая не загружена вовсе.

   Остановите работу стресс-теста на первой ВМ. В командной строке используйте сочетание клавиш **Ctrl + C**.

   Через некоторое время усреднённое значение достигнет 25%, тогда Instance Groups удалит лишнюю ВМ:

   Остановите второй стресс-тест. Через некоторое время после того, как усредненное значение достигнет нуля, Instance Groups удалит вторую дополнительную ВМ.

   При минимальной нагрузке остаются работать две машины:

Вот так при растущей нагрузке группа ВМ автоматически масштабируется, чтобы обеспечить доступность ресурса.