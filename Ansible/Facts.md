### Ansible Facts

Статичное описание переменных для группы хостов в **inventory** или файлах `group_vars` ограничено своей природой. При сопровождении развитого проекта возникает необходимость получения информации о целевых хостах и выполнении действий на основе таких данных.

Например, разные дистрибутивы могут использовать разные пакетные менеджеры или по своему интерпретировать стандарт FHS. В задачах приходится учитывать эти различия и принимать решение на основе фактов, собранных Ansible.

При запуске плея, при первом подключении к хостам и до запуска указанных задач, Ansible запускает модуль `setup`, который выполняет анализ окружения целевого хоста и формирует набор переменных в словаре `ansible_facts`.

### Отключение сбора фактов.

Может пригодиться в особых случаях, например, в автоматизированных пайплайнах создания и настройки виртуальных машин. После создания облачная платформа может рапортовать об успешном выполнении задачи, хотя операционная система внутри виртуальной машины ещё не запустилась. Чтобы автоматизация SCM не упала с ошибкой, можно поставить задачу ожидания подключения, а сбор фактов отключить:

```bash
- hosts: whatever
  gather_facts: no
  tasks:
    - name: Wait for Connection
      ansible.builtin.wait_for_connection: 
```

### Фильтрация фактов

После успешного подключения к виртуальной машине можно явно запустить сбор фактов, но ограничиться только необходимыми:

```bash
- hosts: whatever
  gather_facts: no
  tasks:
    - name: Wait for Connection
      ansible.builtin.wait_for_connection:
    - name: Collect only selected facts
      ansible.builtin.setup:
        filter:
          - 'ansible_distribution'
          - 'ansible_machine_id'
          - 'ansible_*_mb' 
```

### Кэширование

В редко меняющейся инфраструктуре поможет конфигурация кэширования фактов хоста. Это делается в файле `ansible.cfg`, а конфигурация простого кэша в локальной директории может выглядеть следующим образом:

**ansible.cfg**

```bash
[inventory]
cache = True
cache_plugin = jsonfile
cache_connection = ~/.cache/ansible
cache_timeout = 3600 
```